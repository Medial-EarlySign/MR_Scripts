name: Build medpython (Windows)

on:
  workflow_dispatch:
    inputs:
      python_version:
        description: 'Python Version to Build'
        required: true
        default: '3.10'
        type: choice
        options:
          - '3.9'
          - '3.10'
          - '3.11'
          - '3.12'
          - '3.13'
          - '3.14'
      publish_to_pypi:
        description: 'Publish to PyPI?'
        required: true
        default: false
        type: boolean

permissions:
  contents: read
  id-token: write

jobs:
  build_windows_wheels:
    name: Build on Windows (${{ inputs.python_version }})
    runs-on: windows-latest
    environment:
      name: pypi
      url: https://pypi.org/project/medpython
    
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout DevOps Repo
        uses: actions/checkout@v6

      - name: Set up Python ${{ inputs.python_version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ inputs.python_version }}

      # --- 1. BUILD WHEEL ---
      - name: Build MedPython Package
        run: |
          echo "Using Boost at: $BOOST_ROOT"
          
          # 1. Clone Repos (Public)
          git clone https://github.com/Medial-EarlySign/medpython.git MR_LIBS
          git clone https://github.com/Medial-EarlySign/MR_Tools.git
          
          # 2. Copy ETL files (Same logic as Mac/Linux)
          DEST_DIR="MR_LIBS/Internal/MedPyExport/generate_binding/src/ETL_Infra"
          mkdir -p "$DEST_DIR"
          cp -R MR_Tools/RepoLoadUtils/common/ETL_Infra/*.py "$DEST_DIR"
          cp -R MR_Tools/RepoLoadUtils/common/ETL_Infra/tests "$DEST_DIR"
          cp -R MR_Tools/RepoLoadUtils/common/ETL_Infra/rep_signals "$DEST_DIR"
          cp -R MR_Tools/RepoLoadUtils/common/ETL_Infra/data_fetcher "$DEST_DIR"
          cp -R MR_Tools/RepoLoadUtils/common/ETL_Infra/dicts "$DEST_DIR"
          
          cd MR_LIBS/Internal/MedPyExport/generate_binding
          
          # 3. Version Logic
          GIT_COMMIT_HASH=$(git rev-parse HEAD)
          version_in_toml=$(grep version pyproject.toml | cut -d " " -f 3 | sed 's|"||g')
          version_txt=$(date +"Version_${version_in_toml}_Commit_${GIT_COMMIT_HASH}_Build_On_%Y%m%d_%H:%M:%S")
          echo "Building Version: $version_txt"
          export GIT_HEAD_VERSION=$version_txt 

          mkdir -p wheelhouse
          mkdir -p dist
          
          # 4. Install Build Deps
          pip install build delvewheel numpy setuptools cmake "swig<4.3" pandas plotly

          # 5. Build
          # We pass -DBoost_NO_BOOST_CMAKE=ON to ensure it uses our cached Boost properly.
          export CMAKE_ARGS="-DBoost_NO_BOOST_CMAKE=ON"
          
          python -m build --wheel --outdir dist/

          # 6. Repair Wheels (Delvewheel)
          # This bundles any missing non-system DLLs (like specific OpenMP runtimes if needed)
          echo "Repairing wheels with delvewheel..."
          for whl in dist/*.whl; do
              delvewheel repair --wheel-dir wheelhouse/ "$whl"
          done
          
          ls -l wheelhouse/

      # --- UPLOAD ARTIFACT (Prepare for Job 2) ---
      - name: Upload Wheels
        uses: actions/upload-artifact@v4
        with:
          name: win-wheels
          # We grab the repaired wheels from wheelhouse
          path: MR_LIBS/Internal/MedPyExport/generate_binding/wheelhouse/*.whl
          retention-days: 1


  # --- JOB 2: PUBLISH (Runs on Linux) ---
  publish_to_pypi:
    name: Publish to PyPI
    needs: build_windows_wheels
    runs-on: ubuntu-latest
    if: ${{ inputs.publish_to_pypi == true }}
    environment:
      name: pypi
      url: https://pypi.org/project/medpython

    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Download Wheels
        uses: actions/download-artifact@v4
        with:
          name: win-wheels
          path: dist/  # Put them in a 'dist' folder for the publisher

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/